<!DOCTYPE html> <html> <head>
  <meta charset="utf-8">
  <title>Shopbot Example App</title>
  <!-- From bootstrap -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/normalize.css">
  <link rel="stylesheet" href="./css/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
	<nav class="navbar navbar-default" role="navigation">
	<div class="container-fluid">
	  <div class="navbar-header">
		<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="brand" href="/"><img src="./images/shopbot_logo.png"></a>
	  </div>
	  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
		<ul class="nav navbar-nav" style="margin-right: 20%;">
		  <li><a><span class="label status-label label-default tool-state">&nbsp;</span></a></li>
		  <li><a><strong>X: </strong><span class="posx"></span></a></li>
		  <li><a><strong>Y: </strong><span class="posy"></span></a></li>
		  <li><a><strong>Z: </strong><span class="posz"></span></a></li>
		  <li class="hide filename-display"><a><strong>File: </strong><span class="filename"></span></a></li>
		</ul>
		  <button type="button" style="margin-left: 5px; margin-right: 5px;" class="btn btn-default navbar-btn navbar-right" id="keypad" data-target="#manual-modal" data-toggle="modal"><span class="glyphicon glyphicon-screenshot"></span>
		  <button type="button" style="margin-left: 5px; margin-right: 5px;" class="btn btn-warning navbar-btn navbar-right pause-button hide"><span class="glyphicon glyphicon-pause"></span></button>
		  <button type="button" style="margin-left: 5px; margin-right: 5px;" class="btn btn-success navbar-btn navbar-right resume-button hide"><span class="glyphicon glyphicon-play"></span></button>
		<button type="button" style="margin-left: 5px; margin-right: 5px;" class="btn btn-danger navbar-btn navbar-right stop-button hide"><span class="glyphicon glyphicon-stop"></span></button>
	  </div><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
  </nav>

  <div class="container">
	<div class="panel panel-default">
	  <div class="panel-heading app-heading">FabMo G-Code Streamer</div>
	  <div class="panel-body">
		<table class="table table-hover table-bordered" id="files">
		  <tr><th colspan="3">Files on the tool (click to run)</th></tr>
		</table>
		<strong>Upload a file...</strong>
		<p>
		<form id="add_file" action="/file" method="post" enctype="multipart/form-data">
		  <div class="pull-left">
			<input id='file_selector' type="file" name="file" data-filename-placement="inside" title="Browse...">
		  </div>
		  <div class="pull-right">
			<button type="submit" class="btn btn-default btn-primary">
				<span class="glyphicon glyphicon-upload"></span>Upload
			</button>
		  </div>
		</form>
		</p>
	</div>
	</div>
	<div class="panel panel-default">
		<div class="panel-heading app-heading">Single G-Code</div>
		<div class="panel-body">
			<form id="gcode-sender" action="/run" method="post" enctype="multipart/form-data" role="form" class="">
				<input id="gcode-input" class="form-control input-lg" type="text" onclick="this.select();">
			</form>
		</div>
	</div>

		<div class="panel panel-default">
		<div class="panel-heading app-heading">Single OpenSBP Command</div>
		<div class="panel-body">
			<form id="sbp-sender" action="/run" method="post" enctype="multipart/form-data" role="form" class="">
				<input id="sbp-input" class="form-control input-lg" type="text" onclick="this.select();">
			</form>
		</div>
	</div>
  </div>

<!-- KEYBOARD DIALOG -->
<div class="modal fade" id="manual-modal" tabindex="-1" role="dialog" aria-labelledby="manual-modal-label" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
				</button>
				<h4 class="modal-title" id="manual-modal-label">Manual Control</h4>
				<!--<span class="label status-label label-default tool-state pull-right">&nbsp;</span>-->
			</div>
			<div class="modal-body">
				<div class="container-fluid">
					<div class="row">
						<div class="col-xs-6">
							<form class="form-horizontal" role="form">
								<div class="form-group">
									<label for="modal-posx" class="col-sm-2 control-label">X:</label>
									<div class="col-sm-10">
										<div class="input-group">
											<input type="text" class="form-control posx dropdown" id="modal-posx"></input>
											<div class="input-group-addon dropdown-toggle" data-toggle="dropdown" style="cursor: pointer;" id="dropdownMenu1">
											<span class="caret"></span>
											</div>
											<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="homex-button">Home Axis</a></li>
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="zerox-button">Zero Axis</a></li>
											</ul>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="modal-posy" class="col-sm-2 control-label">Y:</label>
									<div class="col-sm-10">
										<div class="input-group">
											<input type="text" class="form-control posy" id="modal-posy"></input>
											<div class="input-group-addon dropdown-toggle" data-toggle="dropdown" style="cursor: pointer;" id="dropdownMenu1">
											<span class="caret"></span>
											</div>
											<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="homey-button">Home Axis</a></li>
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="zeroy-button">Zero Axis</a></li>
											</ul>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="modal-posz" class="col-sm-2 control-label">Z:</label>
									<div class="col-sm-10">
										<div class="input-group">
											<input type="text" class="form-control posz" id="modal-posz"></input>
											<div class="input-group-addon dropdown-toggle" data-toggle="dropdown" style="cursor: pointer;" id="dropdownMenu1">
											<span class="caret"></span>
											</div>
											<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="homez-button">Home Axis</a></li>
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="zeroz-button">Zero Axis</a></li>
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="probez-button">Probe Axis</a></li>
											</ul>
										</div>
									</div>
								</div>
							</form>
							<div class="pull-right">
							<button class="btn btn-default homexy-button">
								<span class="glyphicon glyphicon-home"></span> Home XY
							</button>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="container-fluid">
								<div class="row" style="margin-top: 15px;">
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-plus-Z">↥</button></div>
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-plus-Y">↑</button></div>
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-minus-Z">↧</button></div>
								</div>							
								<div class="row" style="margin-top: 15px;">
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-minus-X">←</button></div>
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-minus-Y">↓</button></div>
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-plus-X">→</button></div>
								</div>							
							</div>
						</div>

					</div>
				</div>
			</div> <!-- modal-body -->
			<!--
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary">Save changes</button>
			</div> -->
		</div>
	</div>
</div>


  <script src="./js/libs/jquery-1.10.2.js"></script>
  <script src="./js/bootstrap.min.js"></script>
  <script src="./js/libs/bootstrap.file-input.js"></script>
  <script src="./js/FabMo-latest.js"></script>
  <script src="./js/FabMo-UI.js"></script>

  
  <script type="text/javascript">
	var tool = new FabMo(location.hostname||'localhost', '8080');
	/*************************************** keypad move section ****************************************/
	var keypad_allow=false;
	var lock_right = false,lock_left = false ,lock_up = false ,lock_down = false,lock_page_up = false,lock_page_down = false;

	function gcode(string) {
		tool.gcode(string,function(err,data){
			if(!err) {
				console.log('Success: ' + string);
			} else {
				console.log('Failure: ' + string);
			}
		});
	}

	$('#manual-modal').on('show.bs.modal', function (e) {
		keypad_allow = true;
	})


	$('#manual-modal').on('hide.bs.modal', function (e) {
		keypad_allow = false;
	})

	$('#manual-modal').keydown(function(e) {
	if (keypad_allow){
		if (e.which === 37 && !lock_left && !lock_right) //left
		{
			lock_left=true;
			tool.start_move("-x",function(){});
		}
		if (e.which === 38 && !lock_up && !lock_down) //up
		{
			 lock_up=true;
			 tool.start_move("y",function(){});
		}
		if (e.which === 39 && !lock_right && !lock_left) //right
		{
			 lock_right=true;
			 tool.start_move("x",function(){});
		}
		if (e.which === 40  && !lock_up && !lock_down) //down
		{
			 lock_down=true;
			tool.start_move("-y",function(){});
		}
		if (e.which === 33  && !lock_page_up && !lock_page_down) //page_up
		{
			 lock_page_up=true;
			tool.start_move("z",function(){});
		}
		if (e.which === 34 && !lock_page_up && !lock_page_down) //page_down
		{
			 lock_page_down=true;
			 tool.start_move("-z",function(){});
		}
	}
	});
		$(document).keyup(function(e) {
	if (keypad_allow){
		if (e.which === 37 ) //left
		{
			lock_left=false;
			tool.stop_move(function(){});
		}
		if (e.which === 38 ) //up
		{
			lock_up=false;
			tool.stop_move(function(){});
		}
		if (e.which === 39 ) //right
		{
			lock_right=false;
			tool.stop_move(function(){});
		}
		if (e.which === 40 ) //down
		{
			lock_down=false;
			tool.stop_move(function(){});
		}
		if (e.which === 33 ) //page_up
		{
			lock_page_up=false;
			tool.stop_move(function(){});
		}
		if (e.which === 34 ) //page_down
		{
			lock_page_down=false;
			tool.stop_move(function(){});
		}
	}
	});
	/************************************* end keypad move section **************************************/

	$(document).ready(function(){
	  // Style the file input so it looks nice
	  $('input[type=file]').bootstrapFileInput();

	  // Load the list of files available on the tool
	  refresh_files_list();

	  setInterval(timer, 100);
	});

	function update_text(control, txt) {
		t = control.text();
		v = control.val();
		if(t != txt) {
			control.text(txt);
		}
		if(v != txt) {
			control.val(txt);
		}
	}
	function timer() {
	tool.get_status(function(err,status){
	if(!err){
		x = status.posx.toFixed(3);
		y = status.posy.toFixed(3);
		z = status.posz.toFixed(3);

		update_text($('.posx'), x);
		update_text($('.posy'), y);
		update_text($('.posz'), z);

		if(status.current_file) {
			$('.filename-display').removeClass('hide');
			$('.filename').html(status.current_file);
		} else {
			$('.filename-display').addClass('hide');
			$('.filename').empty();
		}

		if(status.state === 'idle') {
			$('.status-label').removeClass('label-success label-danger label-info label-warning');
			$('.status-label').addClass('label-default');
			$('.tool-state').html('Idle');
			$('.stop-button').addClass('hide');
			$('.resume-button').addClass('hide');
			$('.pause-button').addClass('hide');
		}
		else if(status.state === 'running' || status.state === 'homing' || status.state === 'probing') {
			$('.status-label').removeClass('label-default label-danger label-info label-warning');
			$('.status-label').addClass('label-success');
			$('.tool-state').html('' + status.state);
			$('.stop-button').removeClass('hide');
			$('.pause-button').removeClass('hide');
			$('.resume-button').addClass('hide');
		}
		else if(status.state === 'manual') {
			$('.status-label').removeClass('label-default label-danger label-info label-warning');
			$('.status-label').addClass('label-success');
			$('.tool-state').html('' + status.state);
			$('.stop-button').addClass('hide');
			$('.pause-button').addClass('hide');
			$('.resume-button').addClass('hide');
		}
		else if(status.state == 'paused') {
			$('.status-label').removeClass('label-success label-info label-default label-danger');
			$('.status-label').addClass('label-warning');
			$('.tool-state').html('Paused');
			$('.stop-button').removeClass('hide');
			$('.pause-button').addClass('hide');
			$('.resume-button').removeClass('hide');
		} 
		else if(status.state == 'limit') {
			$('.status-label').removeClass('label-success label-info label-default label-danger');
			$('.status-label').addClass('label-warning');
			$('.tool-state').html('Limit');
			$('.stop-button').removeClass('hide');
			$('.pause-button').addClass('hide');
			$('.resume-button').removeClass('hide');
			$('.stop-button').addClass('hide');
		}
		else {
			console.log('unknown status');
		}
	}
	else if(err == tool.default_error.no_device){
		$('.posx').html('???');
		$('.posy').html('???');
		$('.posz').html('???');
		$('.status-label').removeClass('label-success label-default label-warning label-info');
		$('.status-label').addClass('label-danger');
		$('.tool-state').html('Disconnected');
		$('.stop-button').addClass('hide');
		$('.pause-button').addClass('hide');
		$('.resume-button').addClass('hide');

	}
	else{
		$('.posx').html('???');
		$('.posy').html('???');
		$('.posz').html('???');
		$('.status-label').removeClass('label-success label-default label-info label-warning');
		$('.status-label').addClass('label-danger');
		$('.tool-state').html('Error');
		$('.stop-button').addClass('hide');
		$('.pause-button').addClass('hide');
		$('.resume-button').addClass('hide');
	}

		});
	}

	function refresh_files_list(){
	  // Load the list of files available on the tool
	  tool.list_files(function(err,files){
	$(".files_list").remove();
		$.each( files, function( key, val ) {
		  $("#files").append( "<tr class='files_list'>"+
		"<td class='run-button' value='" + val._id + "'><a style='cursor: pointer;'>" + val.filename + "</a></td>" +
		"<td class='view-button' value='" + val._id + "' style='text-align: right;width: 3%;'><span style='cursor: pointer;' class='glyphicon glyphicon-eye-open'></span></td>"+
		"<td class='download-button' value='" + val._id + "' style='text-align: right;width: 3%;'><span style='cursor: pointer;' class='glyphicon glyphicon-download-alt'></span></td>" +
		"<td class='delete-button' value='" + val._id + "' style='text-align: right;width: 3%;'><span style='cursor: pointer;' class='glyphicon glyphicon-remove'></span></td>"+
		"</tr>");
		});
	  });
	}


	$('.pause-button').click(function(e) {
		tool.pause(function(){});
	});
	$('.resume-button').click(function(e) {
		tool.resume(function(){});
	});
	$('.stop-button').click(function(e) {
		tool.quit(function(){});
	});



	$('#add_file').submit(function(e){
	e.preventDefault();
		tool.upload_file($(this),function(err,file){
		if(err){console.log(err);return;}
		$('#file_selector').replaceWith($('#file_selector').clone(true)); //reset file field
		$('#file_selector').prev().html('Browse for a file to upload...');
			refresh_files_list();
	});
	});



	$(' tbody').on( "click", 'tr .delete-button', function(e) {	
	tool.delete_by_id($(this).attr('value'),function(err) {
	if(!err)	
		refresh_files_list();
	else
		alert(err);
	});
   });

	$(' tbody').on( "click", 'tr .download-button', function(e) {	
	tool.download_by_id($(this).attr('value'));
});

	$(' tbody').on( "click", 'tr .run-button', function(e) {	
	tool.run_by_id($(this).attr('value'),function(err){
	if(!err)	
		console.log('file is running !');
	else
		alert(err);
	});

});

	function flash_input(cls, value, duration) {
		if(value === 'error') {
			$(cls).addClass('has-success');
			$(cls).removeClass('has-error');
		} else if(value === 'success') {
			$(cls).addClass('has-success');
			$(cls).removeClass('has-error');
		}
		setTimeout(function() {
			$(cls).removeClass('has-error');
			$(cls).removeClass('has-success');
		}, duration);
	}

	$('#gcode-sender').submit(function(e) {
	e.preventDefault();
	tool.gcode($('#gcode-input').val(),function(err,data){
		if(!err) {
			console.log('success');
			flash_input('#gcode-sender', 'success', 500);
		} else {
			console.log('failure');
			flash_input('#gcode-sender', 'error', 500);
		}
	});
	});

	$('#sbp-sender').submit(function(e) {
	e.preventDefault();
	tool.sbp($('#sbp-input').val(),function(err,data){
		if(!err) {
			console.log('success');
			flash_input('#sbp-sender', 'success', 500);
		} else {
			console.log('failure');
			flash_input('#sbp-sender', 'success', 500);
		}
	});
	});
	
	$('.homex-button').click(function(e) {gcode('G28.2 X0'); });
	$('.homey-button').click(function(e) {gcode('G28.2 Y0'); });
	$('.homez-button').click(function(e) {gcode('G28.2 Z0'); });
	$('.homexy-button').click(function(e) {gcode('G28.2 X0 Y0'); });

	$('.probez-button').click(function(e) {gcode('G38.2 Z-4 F10\nG10 L2 P1 Z-0.125'); });   

	$('.zerox-button').click(function(e) {gcode('G28.3 X0'); });  
	$('.zeroy-button').click(function(e) {gcode('G28.3 Y0'); });  
	$('.zeroz-button').click(function(e) {gcode('G28.3 Z0'); });  



	$('.button-plus-X').mousedown(function(e) {
		var e1 = jQuery.Event("keydown");
		e1.which = 39; 
		$('#manual-modal').trigger(e1);
	});  
	$('.button-minus-X').mousedown(function(e) {
		var e1 = jQuery.Event("keydown");
		e1.which = 37; 
		$('#manual-modal').trigger(e1);
	});
	$('.button-plus-Y').mousedown(function(e) {
		var e1 = jQuery.Event("keydown");
		e1.which = 38; 
		$('#manual-modal').trigger(e1);
	});  
	$('.button-minus-Y').mousedown(function(e) {
		var e1 = jQuery.Event("keydown");
		e1.which = 40; 
		$('#manual-modal').trigger(e1);
	});
	$('.button-plus-Z').mousedown(function(e) {
		var e1 = jQuery.Event("keydown");
		e1.which = 33; 
		$('#manual-modal').trigger(e1);
	});  
	$('.button-minus-Z').mousedown(function(e) {
		var e1 = jQuery.Event("keydown");
		e1.which = 34; 
		$('#manual-modal').trigger(e1);
	});

	$('.button-plus-X').mouseup(function(e) {
		var e1 = jQuery.Event("keyup");
		e1.which = 39; 
		$('#manual-modal').trigger(e1);
	});  
	$('.button-minus-X').mouseup(function(e) {
		var e1 = jQuery.Event("keyup");
		e1.which = 37; 
		$('#manual-modal').trigger(e1);
	});
	$('.button-plus-Y').mouseup(function(e) {
		var e1 = jQuery.Event("keyup");
		e1.which = 38; 
		$('#manual-modal').trigger(e1);
	});  
	$('.button-minus-Y').mouseup(function(e) {
		var e1 = jQuery.Event("keyup");
		e1.which = 40; 
		$('#manual-modal').trigger(e1);
	});
	$('.button-plus-Z').mouseup(function(e) {
		var e1 = jQuery.Event("keyup");
		e1.which = 33; 
		$('#manual-modal').trigger(e1);
	});  
	$('.button-minus-Z').mouseup(function(e) {
		var e1 = jQuery.Event("keyup");
		e1.which = 34; 
		$('#manual-modal').trigger(e1);
	});


	/*
	$('#keypad').click(function(e) {
	if (keypad_allow)
		{
		$(this).css('opacity',0.2);
		keypad_allow = false;
	}
	else
		{
		$(this).css('opacity',1);
		keypad_allow = true;
	} 
	
	});
*/

  </script>

</body>
</html>
